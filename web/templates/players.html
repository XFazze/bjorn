{% extends 'base.html' %}

{% block title %}Players - Bjorn Bot Dashboard{% endblock %}

{% block head %}
<style>
    .emoji-font {
        font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        font-size: 0.9em;
        margin-left: 4px;
    }
    .tier-badge {
        display: inline;
        background: none;
        border: none;
        padding: 0;
        box-shadow: none;
    }
    .rank-separator {
        margin: 0 6px;
        opacity: 0.5;
        font-size: 0.8em;
        color: var(--discord-muted);
    }

    /* View toggle styles */
    .view-toggle {
        margin-bottom: 20px;
    }

    .view-toggle .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 120px;
    }

    .view-toggle .btn i {
        margin-right: 8px;
    }

    /* Simplified Player Card Grid */
    .player-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }

    /* Simplified Player Card */
    .player-card {
        background: var(--discord-secondary);
        border-radius: 8px;
        transition: all 0.2s ease;
        height: 100%;
        box-shadow: var(--shadow-sm);
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    .player-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-sm);
    }

    /* Player header with rank and tier */
    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .player-card .rank {
        background: rgba(var(--discord-tertiary-rgb), 0.4);
        color: var(--discord-text);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.8rem;
    }

    /* Player name and MMR */
    .player-card .player-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--discord-text);
    }

    .player-card .mmr-badge {
        font-size: 0.9rem;
        margin-bottom: 16px;
        display: block;
        color: var(--discord-muted);
    }

    .player-card .mmr-badge strong {
        color: var(--discord-text);
    }

    /* Simple stats display */
    .player-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 16px;
        background: rgba(var(--discord-tertiary-rgb), 0.2);
        border-radius: 6px;
        padding: 10px;
    }

    .player-card .stat {
        text-align: center;
        flex: 1;
    }

    .player-card .stat-label {
        font-size: 0.7rem;
        color: var(--discord-muted);
        margin-bottom: 4px;
        text-transform: uppercase;
    }

    .player-card .stat-value {
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Action button */
    .player-card .action {
        margin-top: auto;
        text-align: right;
    }

    .player-card .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }

    /* Hide one view by default */
    #card-view {
        display: none;
    }

    /* Show card view when the page has card-view-active class */
    body.card-view-active #card-view {
        display: block;
    }

    body.card-view-active #table-view {
        display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .player-card-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }

        .view-toggle .btn {
            width: 100px;
            padding: 6px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Improved page header with cleaner structure -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-lg-6 mb-3 mb-lg-0">
            <h1>
                <i class="fas fa-users"></i>
                Players
            </h1>
            <p class="lead">Browse and search through all registered players</p>
        </div>
        <div class="col-lg-6">
            <div class="search-container">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" 
                           id="playerSearch" 
                           class="form-control" 
                           placeholder="Search by player name...">
                    <button class="btn btn-link text-muted d-none" 
                            id="clearSearch" 
                            type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View toggle buttons and count display -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <span class="badge bg-secondary" id="player-count">{{ players|length }} Players</span>
    </div>
    <div class="view-toggle btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary active" id="table-view-btn">
            <i class="fas fa-table"></i> Table
        </button>
        <button type="button" class="btn btn-outline-secondary" id="card-view-btn">
            <i class="fas fa-th"></i> Cards
        </button>
    </div>
</div>

<!-- Card View - Simplified Design -->
<div id="card-view">
    <!-- Add sorting controls for card view -->
    <div class="d-flex justify-content-end mb-3">
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary active" 
                    onclick="sortPlayers('mmr', 'desc', event)">
                    <i class="fas fa-sort-numeric-down me-1"></i>MMR
            </button>
            <button type="button" class="btn btn-outline-primary" 
                    onclick="sortPlayers('win_rate', 'desc', event)">
                    <i class="fas fa-percentage me-1"></i>Win Rate
            </button>
            <button type="button" class="btn btn-outline-primary" 
                    onclick="sortPlayers('games', 'desc', event)">
                    <i class="fas fa-gamepad me-1"></i>Games
            </button>
        </div>
    </div>

    <div class="player-card-grid">
        {% for player in players %}
        <div class="player-card" data-mmr="{{ player.mmr }}" data-win-rate="{{ player.win_rate }}" 
             data-games="{{ player.wins + player.losses }}">
            <div class="player-header">
                <span class="tier-badge emoji-font">{{ player.mmr|mmr_tier }}</span>
                <span class="rank">{{ loop.index }}</span>
            </div>
            
            <span class="player-name">{{ player.discord_name }}</span>
            <span class="mmr-badge"><strong>{{ player.mmr }}</strong> MMR</span>
            
            <div class="player-stats">
                <div class="stat">
                    <div class="stat-label">Wins</div>
                    <div class="stat-value text-success">{{ player.wins }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Losses</div>
                    <div class="stat-value text-danger">{{ player.losses }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value">{{ player.win_rate }}%</div>
                </div>
            </div>
            
            <div class="action">
                <a href="{{ url_for('player_detail', player_id=player.discord_id) }}" 
                   class="btn btn-sm btn-outline-primary">View Profile</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Table View -->
<div id="table-view">
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <i class="fas fa-list me-2"></i>All Players 
                </div>
                <div class="col text-end">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" 
                                onclick="sortPlayers('mmr', 'desc', event)">
                                <i class="fas fa-sort-numeric-down me-1"></i>MMR
                        </button>
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="sortPlayers('win_rate', 'desc', event)">
                                <i class="fas fa-percentage me-1"></i>Win Rate
                        </button>
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="sortPlayers('games', 'desc', event)">
                                <i class="fas fa-gamepad me-1"></i>Games
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="playersTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>MMR</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Win Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in players %}
                        <tr data-mmr="{{ player.mmr }}" data-win-rate="{{ player.win_rate }}" 
                            data-games="{{ player.wins + player.losses }}">
                            <td class="rank-cell">{{ loop.index }}</td>
                            <td>
                                <div class="player-name">
                                    {{ player.discord_name }}
                                    <span class="rank-separator">•</span>
                                    <span class="tier-badge emoji-font">{{ player.mmr|mmr_tier }}</span>
                                </div>
                            </td>
                            <td><strong>{{ player.mmr }}</strong></td>
                            <td><span class="text-success">{{ player.wins }}</span></td>
                            <td><span class="text-danger">{{ player.losses }}</span></td>
                            <td>
                                <span class="win-rate-badge {% if player.win_rate >= 60 %}win-rate-high{% elif player.win_rate >= 45 %}win-rate-medium{% else %}win-rate-low{% endif %}">
                                    <i class="fas {% if player.win_rate >= 60 %}fa-trophy{% elif player.win_rate >= 45 %}fa-chart-line{% else %}fa-chart-line{% endif %} me-1"></i>
                                    {{ player.win_rate }}%
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('player_detail', player_id=player.discord_id) }}" 
                                   class="btn btn-sm btn-primary">
                                   <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Player search functionality
        const searchInput = document.getElementById('playerSearch');
        const clearSearchBtn = document.getElementById('clearSearch');
        const playerCount = document.getElementById('player-count');
        const tableRows = document.querySelectorAll('#playersTable tbody tr');
        const cardElements = document.querySelectorAll('.player-card');

        // Initialize view toggle
        const tableViewBtn = document.getElementById('table-view-btn');
        const cardViewBtn = document.getElementById('card-view-btn');

        // Set initial view from localStorage or default to table
        const savedView = localStorage.getItem('playerViewMode') || 'table';
        if (savedView === 'card') {
            document.body.classList.add('card-view-active');
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
        }

        // Toggle between table and card views
        tableViewBtn.addEventListener('click', function() {
            document.body.classList.remove('card-view-active');
            tableViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            localStorage.setItem('playerViewMode', 'table');
        });

        cardViewBtn.addEventListener('click', function() {
            document.body.classList.add('card-view-active');
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
            localStorage.setItem('playerViewMode', 'card');
        });

        // Search functionality that works for both views
        searchInput.addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            let resultsCount = 0;

            // Search in table view
            tableRows.forEach(row => {
                const playerName = row.querySelector('.player-name').textContent.toLowerCase();
                if (playerName.includes(searchText)) {
                    row.style.display = '';
                    resultsCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Search in card view
            cardElements.forEach(card => {
                const playerName = card.querySelector('.player-name').textContent.toLowerCase();
                if (playerName.includes(searchText)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });

            // Update player count
            playerCount.textContent = resultsCount + ' Players';

            // Show/hide clear button
            if (searchText.length > 0) {
                clearSearchBtn.classList.remove('d-none');
            } else {
                clearSearchBtn.classList.add('d-none');
                playerCount.textContent = '{{ players|length }} Players';
            }

            // Show "no results" message if needed
            showNoResultsMessage(searchText, resultsCount);
        });

        // Clear search functionality
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                // Trigger the search event to reset the table
                searchInput.dispatchEvent(new Event('keyup'));
                searchInput.focus();
            });
        }

        function showNoResultsMessage(searchText, resultsCount) {
            const tableBody = document.querySelector('#playersTable tbody');
            const cardView = document.getElementById('card-view');
            let noResultsRow = document.getElementById('no-results-row');
            let noResultsCard = document.getElementById('no-results-card');

            // Handle table view no results
            if (resultsCount === 0 && searchText.length > 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'no-results-row';
                    const cell = document.createElement('td');
                    cell.colSpan = 7;
                    cell.className = 'text-center py-4';
                    cell.innerHTML = `<div class="alert alert-info mb-0">
                                       <i class="fas fa-search me-2"></i>No players found matching "${searchText}"
                                     </div>`;
                    noResultsRow.appendChild(cell);
                    tableBody.appendChild(noResultsRow);
                }

                // Also show for card view
                if (!noResultsCard) {
                    noResultsCard = document.createElement('div');
                    noResultsCard.id = 'no-results-card';
                    noResultsCard.className = 'alert alert-info';
                    noResultsCard.innerHTML = `<i class="fas fa-search me-2"></i>No players found matching "${searchText}"`;
                    cardView.appendChild(noResultsCard);
                }
            } else {
                // Remove no results messages if results exist
                if (noResultsRow) noResultsRow.remove();
                if (noResultsCard) noResultsCard.remove();
            }
        }
    });

    // Fixed sorting function that works for both views
    function sortPlayers(column, direction, event) {
        const tableBody = document.querySelector('#playersTable tbody');
        const cardGrid = document.querySelector('.player-card-grid');
        const tableRows = Array.from(tableBody.querySelectorAll('tr:not(#no-results-row)'));
        const cardElements = Array.from(document.querySelectorAll('.player-card'));
        
        // Get all button groups
        const tableButtons = document.querySelectorAll('#table-view .btn-group .btn-outline-primary');
        const cardButtons = document.querySelectorAll('#card-view .btn-group .btn-outline-primary');
        
        // Remove active class from all buttons
        tableButtons.forEach(btn => btn.classList.remove('active'));
        cardButtons.forEach(btn => btn.classList.remove('active'));
        
        // Find the clicked button and add active class
        if (event && event.target) {
            const clickedBtn = event.target.closest('.btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
                
                // Determine which set of buttons was clicked and sync the other set
                const isCardView = clickedBtn.closest('#card-view') !== null;
                const clickedIndex = isCardView ? 
                    Array.from(cardButtons).indexOf(clickedBtn) : 
                    Array.from(tableButtons).indexOf(clickedBtn);
                
                if (clickedIndex !== -1) {
                    // Sync active state to the other view's button
                    if (isCardView && clickedIndex < tableButtons.length) {
                        tableButtons[clickedIndex].classList.add('active');
                    } else if (!isCardView && clickedIndex < cardButtons.length) {
                        cardButtons[clickedIndex].classList.add('active');
                    }
                }
            }
        }

        // Convert underscores to hyphens for data attribute names
        const attributeName = `data-${column.replace('_', '-')}`;

        // Sort table rows
        tableRows.sort((a, b) => {
            const aValue = parseFloat(a.getAttribute(attributeName));
            const bValue = parseFloat(b.getAttribute(attributeName));

            if (isNaN(aValue)) return direction === 'desc' ? 1 : -1;
            if (isNaN(bValue)) return direction === 'desc' ? -1 : 1;

            return direction === 'desc' ? bValue - aValue : aValue - bValue;
        });

        // Sort card elements
        cardElements.sort((a, b) => {
            const aValue = parseFloat(a.getAttribute(attributeName));
            const bValue = parseFloat(b.getAttribute(attributeName));

            if (isNaN(aValue)) return direction === 'desc' ? 1 : -1;
            if (isNaN(bValue)) return direction === 'desc' ? -1 : 1;

            return direction === 'desc' ? bValue - aValue : aValue - bValue;
        });

        // Update ranks and reattach elements
        tableRows.forEach((row, index) => {
            row.style.opacity = '0';
            row.style.transform = 'translateY(5px)';
            row.querySelector('.rank-cell').textContent = index + 1;
            tableBody.appendChild(row);
            
            // Force reflow and animate
            void row.offsetWidth;
            setTimeout(() => {
                row.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, index * 20);
        });
        
        // Update ranks and reattach cards
        cardElements.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(5px)';
            card.querySelector('.rank').textContent = index + 1;
            cardGrid.appendChild(card);
            
            // Force reflow and animate
            void card.offsetWidth;
            setTimeout(() => {
                card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 20);
        });
    }
</script>
{% endblock %}
